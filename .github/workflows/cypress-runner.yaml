name: Cypress Runner
description: |
  Runs Cypress tests in a GitHub Actions workflow. This workflow is designed to be reusable and can be called from other workflows.
  It installs the necessary dependencies, runs linting, executes the Cypress tests, and uploads the test results, screenshots, and videos as artifacts.
on:
  workflow_call:
    inputs:
      environment_name:
        description: ""
        required: true
        type: string
      base_url:
        description: ""
        required: true
        type: string
      working_directory:
        description: ""
        required: true
        type: string
      allow_run:
        description: ""
        type: boolean
        required: true
      oauth_base_url:
        description: ""
        type: string
        required: true
      oauth_tenant_id:
        description: ""
        type: string
        required: true
      oauth_client_id:
        description: ""
        type: string
        required: true
      oauth_user_id:
        description: ""
        type: string
        required: true
      oauth_user_email:
        description: ""
        type: string
        required: true
    secrets:
      oauth_user_password:
        description: ""
        required: true

  workflow_dispatch:

jobs:
  cypress_run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cypress install yarn
        shell: bash
        run: |
          npm install -g yarn

      - name: Cypress install dependencies
        shell: bash
        run: |
          yarn install

      - name: Cypress run lint
        shell: bash
        run: |
          yarn lint

      - name: Cypress run
        shell: bash
        run: |
          yarn cypress run --config baseUrl=${{ inputs.base_url }} --env b2cUrl=${{ inputs.oauth_authorize_url }} --env b2cTenantId=${{ inputs.oauth_tenant_id }} --env b2cClientId=${{ inputs.oauth_client_id }} --env b2cUserObjectId=${{ inputs.oauth_user_id }} --env b2cUserEmail=${{ inputs.oauth_user_email }} --env b2cUserPassword=${{ secrets.oauth_user_password }}

      - name: Cypress upload test results
        uses: actions/upload-artifact@v4
        with:
            name: ${{ inputs.environment_name }}.cypress-test-results
            path: ${{ inputs.working_directory }}/results/
            include-hidden-files: true

      - name: Cypress upload screenshots
        uses: actions/upload-artifact@v4
        with:
            name: ${{ inputs.environment_name }}.cypress-screenshots
            path: ${{ inputs.working_directory }}/cypress/screenshots/
            include-hidden-files: true

      - name: Cypress upload videos
        uses: actions/upload-artifact@v4
        with:
            name: ${{ inputs.environment_name }}.cypress-videos
            path: ${{ inputs.working_directory }}/cypress/videos/
            include-hidden-files: true