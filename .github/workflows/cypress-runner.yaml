name: Cypress Runner
description: |
  Runs Cypress tests in a GitHub Actions workflow. This workflow is designed to be reusable and can be called from other workflows.
  It installs the necessary dependencies, runs linting, executes the Cypress tests, and uploads the test results, screenshots, and videos as artifacts.
on:
  workflow_call:
    inputs:
      environment_name:
        description: ""
        required: true
        type: string
      base_url:
        description: ""
        required: true
        type: string
      working_directory:
        description: ""
        required: true
        type: string
      allow_run:
        description: ""
        type: boolean
        required: true
      command_line_args:
        description: "Command line arguments to pass to cypress"
        required: false
        type: string
        default: ""

  workflow_dispatch:

jobs:
  cypress_run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cypress install yarn
        shell: bash
        working-directory: ${{ inputs.working_directory }}
        run: |
          npm install -g yarn

      - name: Cypress install dependencies
        shell: bash
        working-directory: ${{ inputs.working_directory }}
        run: |
          yarn install

      - name: Cypress run lint
        shell: bash
        working-directory: ${{ inputs.working_directory }}
        run: |
          yarn lint

      - name: Cypress run
        shell: bash
        working-directory: ${{ inputs.working_directory }}
        run: |
          yarn cypress run --config baseUrl=${{ inputs.base_url }}  ${{ inputs.command_line_args }}

      - name: Cypress upload test results
        uses: actions/upload-artifact@v4
        with:
            name: ${{ inputs.environment_name }}.cypress-test-results
            path: ${{ inputs.working_directory }}/results/
            include-hidden-files: true

      - name: Cypress upload screenshots
        uses: actions/upload-artifact@v4
        with:
            name: ${{ inputs.environment_name }}.cypress-screenshots
            path: ${{ inputs.working_directory }}/cypress/screenshots/
            include-hidden-files: true

      - name: Cypress upload videos
        uses: actions/upload-artifact@v4
        with:
            name: ${{ inputs.environment_name }}.cypress-videos
            path: ${{ inputs.working_directory }}/cypress/videos/
            include-hidden-files: true